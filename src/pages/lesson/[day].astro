---
import BaseLayout from '../../layouts/BaseLayout.astro';
import lessonsData from '../../../public/lessons.json';

export function getStaticPaths() {
  return lessonsData.lessons.map(lesson => ({
    params: { day: lesson.dayOfYear.toString() },
    props: { lesson }
  }));
}

const { lesson } = Astro.props;
const dayOfYear = lesson.dayOfYear;

// Calculate the date for this day of year
const year = new Date().getFullYear();
const date = new Date(year, 0);
date.setDate(dayOfYear);
const options = { month: 'long', day: 'numeric' };
const formattedDate = date.toLocaleDateString('en-US', options);

// Get category icon
const categoryIcons = {
  'Mathematics': 'f(x)',
  'Biology': 'ðŸ§¬',
  'Space': 'ðŸŒŒ',
  'Psychology': 'ðŸ§ ',
  'History': 'ðŸ“œ',
  'Physics': 'âš›ï¸',
  'Food Science': 'ðŸ³',
  'Neuroscience': 'ðŸ§ ',
  'Technology': 'ðŸ’»',
  'Art & Culture': 'ðŸŽ¨',
  'Philosophy': 'ðŸ’­',
  'Geography': 'ðŸŒ',
  'Music': 'ðŸŽµ',
  'Economics': 'ðŸ“ˆ',
  'Health': 'â¤ï¸',
  'Language': 'ðŸ“',
  'Chemistry': 'âš—ï¸',
  'Environment': 'ðŸŒ±',
  'Animals': 'ðŸ¦‹'
};

const categoryIcon = categoryIcons[lesson.category] || 'ðŸ“š';

// Check if prev/next lessons exist
const prevDay = dayOfYear > 1 ? dayOfYear - 1 : null;
const nextDay = dayOfYear < 365 ? dayOfYear + 1 : null;

// Get today's day of year
const now = new Date();
const start = new Date(now.getFullYear(), 0, 0);
const diff = now - start;
const oneDay = 1000 * 60 * 60 * 24;
const todayDayOfYear = Math.floor(diff / oneDay);
const isToday = dayOfYear === todayDayOfYear;
---

<BaseLayout title={`${lesson.title} - Day ${dayOfYear} - Knowly`} description={lesson.content.substring(0, 160)}>
  <section class="py-12 md:py-24">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="text-center mb-12">
        {isToday ? (
          <div class="inline-flex items-center gap-2 bg-highlight text-primary px-4 py-2 rounded-full text-sm font-medium mb-6">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
            </svg>
            Today's Lesson
          </div>
        ) : (
          <div class="inline-flex items-center gap-2 bg-card text-text-secondary px-4 py-2 rounded-full text-sm font-medium mb-6">
            Day {dayOfYear} of 365
          </div>
        )}
        <h1 class="text-4xl md:text-5xl font-bold text-text mb-4 text-display">
          {formattedDate}
        </h1>
      </div>

      <!-- Lesson Card -->
      <div class="card p-8 md:p-12">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-secondary-light rounded-full flex items-center justify-center">
              <span class="text-secondary font-semibold text-lg">{categoryIcon}</span>
            </div>
            <span class="text-secondary text-sm font-semibold tracking-wider uppercase">{lesson.category}</span>
          </div>
        </div>

        <h2 class="text-3xl md:text-4xl font-bold text-text mb-4 text-display">
          {lesson.title}
        </h2>
        <div class="w-16 h-1 bg-secondary rounded-full mb-8"></div>

        <p class="text-text-secondary text-lg md:text-xl leading-relaxed mb-10">
          {lesson.content}
        </p>

        <!-- Did you know box -->
        <div class="highlight-box">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-xl">ðŸ’¡</span>
            <span class="font-semibold text-text">Did you know?</span>
          </div>
          <p class="text-text-secondary text-lg">
            {lesson.funFact}
          </p>
        </div>

        <!-- Actions -->
        <div class="mt-10">
          <button
            id="share-lesson"
            class="btn-primary w-full flex items-center justify-center gap-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
            </svg>
            Share this lesson
          </button>
        </div>
      </div>

      <!-- Navigation -->
      <div class="mt-8 flex justify-between items-center">
        {prevDay ? (
          <a
            href={`/lesson/${prevDay}`}
            class="text-text-secondary hover:text-text flex items-center gap-2 transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Previous
          </a>
        ) : (
          <span></span>
        )}
        <a
          href="/lessons"
          class="text-secondary hover:text-secondary/80 font-medium transition-colors"
        >
          Browse All Lessons
        </a>
        {nextDay ? (
          <a
            href={`/lesson/${nextDay}`}
            class="text-text-secondary hover:text-text flex items-center gap-2 transition-colors"
          >
            Next
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </a>
        ) : (
          <span></span>
        )}
      </div>

      <!-- App CTA -->
      <div class="mt-16 card p-8 text-center">
        <h3 class="text-2xl font-bold text-text mb-4 text-display">
          Take Knowly with you
        </h3>
        <p class="text-text-secondary mb-6">
          Get daily lessons, create your own, and build your personal wisdom library
        </p>
        <a
          href="/coming-soon"
          class="btn-primary inline-flex items-center justify-center"
        >
          <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
          </svg>
          Download for iOS
        </a>
      </div>
    </div>
  </section>
</BaseLayout>

<script define:vars={{ lesson }}>
  document.addEventListener('DOMContentLoaded', () => {
    const shareButton = document.getElementById('share-lesson');

    shareButton.addEventListener('click', async () => {
      const shareData = {
        title: lesson.title,
        text: `${lesson.content.substring(0, 100)}...`,
        url: window.location.href
      };

      if (navigator.share) {
        try {
          await navigator.share(shareData);
        } catch (err) {
          console.log('Share cancelled');
        }
      } else {
        await navigator.clipboard.writeText(`${lesson.title}\n\n${lesson.content}\n\nLearn more: ${window.location.href}`);
        const originalText = shareButton.innerHTML;
        shareButton.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          Copied to clipboard!
        `;
        setTimeout(() => {
          shareButton.innerHTML = originalText;
        }, 2000);
      }
    });
  });
</script>
