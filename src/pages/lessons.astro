---
import BaseLayout from '../layouts/BaseLayout.astro';
import lessonsData from '../../public/lessons.json';

const lessons = lessonsData.lessons;
const categories = [...new Set(lessons.map(l => l.category))].sort();
---

<BaseLayout title="Browse Lessons - Knowly" description="Explore 365 fascinating lessons across 19 categories. Learn something new every day.">
  <section class="py-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold text-text mb-4 text-display">
          Browse All Lessons
        </h1>
        <p class="text-xl text-text-secondary max-w-2xl mx-auto">
          Explore 365 fascinating lessons across 19 categories
        </p>
      </div>

      <!-- Search and Filter Controls -->
      <div class="card p-6 mb-8">
        <div class="flex flex-col md:flex-row gap-4">
          <!-- Search -->
          <div class="flex-1">
            <div class="relative">
              <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <input
                type="text"
                id="search-input"
                placeholder="Search lessons..."
                class="w-full pl-12 pr-4 py-3 bg-background rounded-xl border border-border focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-text"
              />
            </div>
          </div>

          <!-- Category Filter -->
          <div class="md:w-64">
            <select
              id="category-filter"
              class="w-full px-4 py-3 bg-background rounded-xl border border-border focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-text appearance-none cursor-pointer"
            >
              <option value="">All Categories</option>
              {categories.map(cat => (
                <option value={cat}>{cat}</option>
              ))}
            </select>
          </div>
        </div>

        <!-- Results count -->
        <div class="mt-4 flex items-center justify-between">
          <p class="text-text-secondary text-sm">
            Showing <span id="results-count" class="font-semibold text-text">{lessons.length}</span> lessons
          </p>
          <button
            id="clear-filters"
            class="text-sm text-secondary hover:text-secondary/80 font-medium hidden"
          >
            Clear filters
          </button>
        </div>
      </div>

      <!-- Category Pills -->
      <div class="flex flex-wrap gap-2 mb-8" id="category-pills">
        <button
          class="category-pill px-4 py-2 rounded-full text-sm font-medium transition-all bg-primary text-white"
          data-category=""
        >
          All
        </button>
        {categories.map(cat => (
          <button
            class="category-pill px-4 py-2 rounded-full text-sm font-medium transition-all bg-card text-text-secondary hover:bg-secondary-light hover:text-secondary"
            data-category={cat}
          >
            {cat}
          </button>
        ))}
      </div>

      <!-- Lessons Grid -->
      <div id="lessons-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {lessons.map((lesson, index) => (
          <article
            class="lesson-card card p-6 hover:shadow-lg transition-shadow cursor-pointer"
            data-category={lesson.category}
            data-title={lesson.title.toLowerCase()}
            data-content={lesson.content.toLowerCase()}
            data-day={lesson.dayOfYear}
          >
            <div class="flex items-center justify-between mb-4">
              <span class="category-badge">{lesson.category}</span>
              <span class="text-text-muted text-sm">Day {lesson.dayOfYear}</span>
            </div>
            <h3 class="text-lg font-semibold text-text mb-3 line-clamp-2">{lesson.title}</h3>
            <p class="text-text-secondary text-sm line-clamp-3 mb-4">{lesson.content}</p>
            <div class="highlight-box">
              <p class="text-text-secondary text-xs line-clamp-2">
                <span class="font-semibold">Fun fact:</span> {lesson.funFact}
              </p>
            </div>
          </article>
        ))}
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden text-center py-16">
        <div class="w-20 h-20 bg-secondary-light rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-10 h-10 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h3 class="text-xl font-semibold text-text mb-2">No lessons found</h3>
        <p class="text-text-secondary mb-6">Try adjusting your search or filter</p>
        <button
          id="reset-search"
          class="text-secondary hover:text-secondary/80 font-medium"
        >
          Clear all filters
        </button>
      </div>
    </div>
  </section>

  <!-- Lesson Modal -->
  <div id="lesson-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="card max-w-2xl w-full max-h-[90vh] overflow-y-auto p-8 relative">
      <button id="close-modal" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-background hover:bg-border flex items-center justify-center transition-colors">
        <svg class="w-5 h-5 text-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>

      <div id="modal-content">
        <!-- Content injected via JS -->
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script define:vars={{ lessons }}>
  const lessonsData = lessons;

  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input');
    const categoryFilter = document.getElementById('category-filter');
    const categoryPills = document.querySelectorAll('.category-pill');
    const lessonCards = document.querySelectorAll('.lesson-card');
    const resultsCount = document.getElementById('results-count');
    const clearFilters = document.getElementById('clear-filters');
    const emptyState = document.getElementById('empty-state');
    const lessonsGrid = document.getElementById('lessons-grid');
    const resetSearch = document.getElementById('reset-search');
    const modal = document.getElementById('lesson-modal');
    const modalContent = document.getElementById('modal-content');
    const closeModal = document.getElementById('close-modal');

    let currentSearch = '';
    let currentCategory = '';

    function filterLessons() {
      let visibleCount = 0;

      lessonCards.forEach(card => {
        const title = card.dataset.title;
        const content = card.dataset.content;
        const category = card.dataset.category;

        const matchesSearch = !currentSearch ||
          title.includes(currentSearch.toLowerCase()) ||
          content.includes(currentSearch.toLowerCase()) ||
          category.toLowerCase().includes(currentSearch.toLowerCase());

        const matchesCategory = !currentCategory || category === currentCategory;

        if (matchesSearch && matchesCategory) {
          card.classList.remove('hidden');
          visibleCount++;
        } else {
          card.classList.add('hidden');
        }
      });

      resultsCount.textContent = visibleCount;

      if (visibleCount === 0) {
        emptyState.classList.remove('hidden');
        lessonsGrid.classList.add('hidden');
      } else {
        emptyState.classList.add('hidden');
        lessonsGrid.classList.remove('hidden');
      }

      if (currentSearch || currentCategory) {
        clearFilters.classList.remove('hidden');
      } else {
        clearFilters.classList.add('hidden');
      }
    }

    function resetFilters() {
      currentSearch = '';
      currentCategory = '';
      searchInput.value = '';
      categoryFilter.value = '';
      updateCategoryPills('');
      filterLessons();
    }

    function updateCategoryPills(selectedCategory) {
      categoryPills.forEach(pill => {
        if (pill.dataset.category === selectedCategory) {
          pill.classList.remove('bg-card', 'text-text-secondary', 'hover:bg-secondary-light', 'hover:text-secondary');
          pill.classList.add('bg-primary', 'text-white');
        } else {
          pill.classList.add('bg-card', 'text-text-secondary', 'hover:bg-secondary-light', 'hover:text-secondary');
          pill.classList.remove('bg-primary', 'text-white');
        }
      });
    }

    function openModal(dayOfYear) {
      const lesson = lessonsData.find(l => l.dayOfYear === parseInt(dayOfYear));
      if (!lesson) return;

      modalContent.innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <span class="category-badge">${lesson.category}</span>
          <span class="text-text-muted text-sm">Day ${lesson.dayOfYear}</span>
        </div>
        <h2 class="text-2xl md:text-3xl font-bold text-text mb-4 text-display">${lesson.title}</h2>
        <div class="w-16 h-1 bg-secondary rounded-full mb-6"></div>
        <p class="text-text-secondary text-lg leading-relaxed mb-8">${lesson.content}</p>
        <div class="highlight-box">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-lg">ðŸ’¡</span>
            <span class="font-semibold text-text text-sm">Did you know?</span>
          </div>
          <p class="text-text-secondary">${lesson.funFact}</p>
        </div>
        <div class="mt-8 flex gap-4">
          <button
            onclick="navigator.share ? navigator.share({title: '${lesson.title}', text: '${lesson.content.substring(0, 100)}...', url: window.location.href}) : null"
            class="btn-secondary flex-1 text-center"
          >
            Share Lesson
          </button>
        </div>
      `;

      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }

    function closeModalHandler() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.style.overflow = '';
    }

    // Event listeners
    searchInput.addEventListener('input', (e) => {
      currentSearch = e.target.value;
      filterLessons();
    });

    categoryFilter.addEventListener('change', (e) => {
      currentCategory = e.target.value;
      updateCategoryPills(currentCategory);
      filterLessons();
    });

    categoryPills.forEach(pill => {
      pill.addEventListener('click', () => {
        currentCategory = pill.dataset.category;
        categoryFilter.value = currentCategory;
        updateCategoryPills(currentCategory);
        filterLessons();
      });
    });

    clearFilters.addEventListener('click', resetFilters);
    resetSearch.addEventListener('click', resetFilters);

    lessonCards.forEach(card => {
      card.addEventListener('click', () => {
        openModal(card.dataset.day);
      });
    });

    closeModal.addEventListener('click', closeModalHandler);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModalHandler();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModalHandler();
    });
  });
</script>
